# TODO: split out to a base app
app-id: org.gnuradio.gnuradio
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
command: gnuradio-companion
rename-desktop-file: gnuradio-grc.desktop
rename-icon: gnuradio-grc
finish-args:
  - --device=all
  - --device=dri
  - --filesystem=home
  - --persist=.cache/grc_gnuradio
  - --persist=.gnuradio
  - --share=network
  - --socket=wayland
cleanup:
#  - /include
#  - /lib/pkgconfig
  - /share/man
  - '*.a'
  - '*.la'
modules:
  - name: gnuradio
    buildsystem: cmake
    builddir: true
    post-install:
      - install -Dm644 ../grc/scripts/freedesktop/gnuradio_logo_icon-square.svg /app/share/icons/hicolor/scalable/apps/gnuradio-grc.svg
      - mv /app/share/mime/packages/gnuradio-grc.xml /app/share/mime/packages/org.gnuradio.gnuradio.xml
# TODO: add udev_rules as docs?
#     - install -Dm644 ../21-fcd.rules /app/docs/udev_rules/21-fcd.rules
    sources:
      - type: archive
        url: https://github.com/gnuradio/gnuradio/archive/v3.9.3.0.tar.gz
        sha256: 4073ac72524f95fed4bda7dd553cb946f66d2e00bd07c4ae7758f1b787d507e0
        x-checker-data:
          type: anitya
          project-id: 1217
          stable-only: true
          url-template: https://github.com/gnuradio/gnuradio/archive/v$version.tar.gz
    modules:
      - ../shared-modules/gsl/gsl.json
      - ../shared-modules/gsm/gsm.json
      - ../shared-modules/lapack/lapack.json
      - ../shared-modules/portaudio/portaudio.json
      - ../shared-modules/pyqt5/pyqt5.json
      - ../shared-modules/python-gobject/python-gobject.json
      - ../shared-modules/python-lxml/python-lxml.json
      - ../shared-modules/python-yaml/python-yaml.json
      - ../shared-modules/qwt/qwt.json
      - ../shared-modules/swig/swig.json
      - ../shared-modules/zeromq/zeromq.json
      - name: codec2
        buildsystem: cmake
        builddir: true
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: archive
            url: https://github.com/drowe67/codec2/archive/v1.0.1.tar.gz
            sha256: 14227963940d79e0ec5af810f37101b30e1c7e8555abd96c56b3c0473abac8ef
            x-checker-data:
              type: anitya
              project-id: 14605
              stable-only: true
              url-template: https://github.com/drowe67/codec2/archive/v$version.tar.gz
      - name: libuhd
        buildsystem: cmake
        subdir: host
        config-opts:
          - -DENABLE_E100=ON
          - -DENABLE_E300=ON
          - -DENABLE_EXAMPLES=OFF
          - -DENABLE_TESTS=OFF
          - -DENABLE_UTILS=OFF
# TODO: add udev_rules as docs?
#       post-install:
#         - install -Dm644 utils/uhd-usrp.rules /app/docs/udev_rules/10-uhd-usrp.rules
        sources:
          - type: archive
            url: https://github.com/EttusResearch/uhd/archive/v4.1.0.4.tar.gz
            sha256: 44983dbc53b582af0040f22c5b18f9e63342d3b8fd26b3aabe60501e01554208
            x-checker-data:
              type: anitya
              project-id: 12572
              stable-only: true
              url-template: https://github.com/EttusResearch/uhd/archive/v$version.tar.gz
        modules:
          - ../shared-modules/boost/boost.json
          - ../shared-modules/python-numpy/python-numpy.json
          - ../flathub-shared-modules/libusb/libusb.json
      - name: log4cpp
        config-opts:
          - --disable-doxygen
          - --disable-dot
          - --without-idsa
        sources:
          - type: archive
            url: https://downloads.sourceforge.net/log4cpp/log4cpp-1.1.3.tar.gz
            sha256: 2cbbea55a5d6895c9f0116a9a9ce3afb86df383cd05c9d6c1a4238e5e5c8f51d
            strip-components: 2
            x-checker-data:
              type: anitya
              project-id: 21499
              stable-only: true
              url-template: https://downloads.sourceforge.net/log4cpp/log4cpp-$version.tar.gz
      - name: python-click-plugins
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "click-plugins" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/5f/1d/45434f64ed749540af821fd7e42b8e4d23ac04b1eda7c26613288d6cd8a8/click-plugins-1.1.1.tar.gz
            sha256: 46ab999744a9d831159c3411bb0c79346d94a444df9a3a3742e9ed63645f264b
            x-checker-data:
              type: pypi
              name: click-plugins
        modules:
          - name: python-click
            buildsystem: simple
            build-commands:
              - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
                --prefix=${FLATPAK_DEST} "click" --no-build-isolation
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/21/83/308a74ca1104fe1e3197d31693a7a2db67c2d4e668f20f43a2fca491f9f7/click-8.0.1.tar.gz
                sha256: 8c04c11192119b1ef78ea049e0a6f0463e4c48ef00a30160c704337586f3ad7a
                x-checker-data:
                  type: pypi
                  name: click
      - name: volk
        # depends on boost, in-tree volk can be used instead
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/gnuradio/volk/releases/download/v2.5.0/volk-2.5.0.tar.xz
            sha256: ddc84d2396e9d3899ff0411a0659f64ba19d75b2210cce83bc2eaa7767429252
            x-checker-data:
              type: anitya
              project-id: 147733
              stable-only: true
              url-template: https://github.com/gnuradio/volk/releases/download/v$version/volk-$version.tar.xz
      - name: pybind11
        # TODO: revisit build steps or their order, setup.py can't find python init files
        buildsystem: cmake
        builddir: true
        config-opts:
          - -DPYBIND11_TEST=OFF
          - -DPYBIND11_CMAKECONFIG_INSTALL_DIR=/app/lib/cmake/pybind11
        post-install:
          - |
            cd ..
            python setup.py build
            python setup.py install --skip-build --prefix=/app --root=/ --optimize=1
        sources:
          - type: archive
            url: https://github.com/pybind/pybind11/archive/v2.8.0.tar.gz
            sha256: 9ca7770fc5453b10b00a4a2f99754d7a29af8952330be5f5602e7c2635fa3e79
            x-checker-data:
              type: anitya
              project-id: 13384
              stable-only: true
              url-template: https://github.com/pybind/pybind11/archive/v$version.tar.gz
          - type: shell
            commands:
              - sed -i 's/\(s.get_python_inc(plat_specific=\)True/\1False/' tools/FindPythonLibsNew.cmake
