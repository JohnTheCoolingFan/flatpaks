# TODO: cleanup
# TODO: move out tremc & byobu to a shared module
#
# Tips
#   * Host access
#     1. use ssh over tcp, get keys from an already running ssh-agent
#     2. use ssh over a unix socket with socat
#     3. run a shell through flatpak-spawn
#        create flatpak overrides
#          $ flatpak override --user --talk-name=org.freedesktop.Flatpak
#        run a shell on the host
#          $ flatpak-spawn --host /bin/bash
#     3. with a terminal multiplexer
#        set environment variables
#          SCREENDIR="$XDG_RUNTIME_DIR"/screen
#          TMUX_TMPDIR="$XDG_RUNTIME_DIR"/tmux
#        create $XDG_CONFIG_HOME/user-tmpfiles.d/tmux.conf
#          d %t/tmux 0700 - - - -
#        create $XDG_CONFIG_HOME/user-tmpfiles.d/screen.conf
#          d %t/screen 0700 - - - -
#        start tmpfiles.d user service
#          $ systemctl --user enable --now systemd-tmpfiles-setup.service
#        create flatpak overrides
#          $ flatpak override --user --filesystem=xdg-run/tmux
#          $ flatpak override --user --filesystem=xdg-run/screen
#   * Update terminfo so apps will work correctly when access the host environment
#     Add the terminfo folders from the flatpak app
#       $ export TERMINFO_DIRS+=":$XDG_DATA_HOME/flatpak/app/com.github.thestinger.termite/current/active/files/share/terminfo"
#     Make sure /usr/share/terminfo is still being used
#       $ export TERMINFO_DIRS+=":
app-id: com.github.thestinger.termite
runtime: org.gnome.Platform
runtime-version: '3.38'
sdk: org.gnome.Sdk
command: termite
rename-desktop-file: termite.desktop
finish-args:
  - --device=dri
  - '--env=TERMINFO_DIRS=/app/share/terminfo:'
  - --filesystem=home
  - --share=ipc
  - --socket=wayland
  - --socket=x11
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
modules:
  - name: termite
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: git
        url: https://github.com/thestinger/termite.git
        tag: v15
      - type: shell
        commands:
          - sed 's#etc/xdg#share#' -i Makefile
    modules:
      - name: vte-ng
        config-opts:
          - --enable-static
          - --disable-shared
          - enable_introspection=no
          - enable_vala=no
          - --disable-gtk-doc
          - --disable-glade-catalogue
        sources:
          - type: archive
            url: https://github.com/thestinger/vte-ng/archive/0.56.2.a.tar.gz
            sha256: 28162f4318cb51a74070dbcc57b6900f7a1de2616cab843a2431fd5cb67fccb3
        cleanup:
          - '*'
        modules:
          - ../flathub-shared-modules/intltool/intltool-0.51.json
#     - name: vte3
#       buildsystem: meson
#       build-options:
#         env:
#           - CXXFLAGS=-fno-exceptions
#       sources:
#         - type: archive
#           url: https://download.gnome.org/sources/vte/0.60/vte-0.60.0.tar.xz
#           sha256: 72d1955eb40b4475b858892813a79545cee34409bac2af470606fb4b4d193a1b
#       cleanup:
#         - /bin
#         - /etc
#         - /include
#         - /lib/pkgconfig
#         - /lib/systemd
#         - /libexec
#         - /share/gir-1.0
#         - /share/vala
  # TODO: add gnu screen
  - name: tmux
    sources:
      - type: archive
        url: https://github.com/tmux/tmux/releases/download/3.1c/tmux-3.1c.tar.gz
        sha256: 918f7220447bef33a1902d4faff05317afd9db4ae1c9971bef5c787ac6c88386
    modules:
      - name: libutempter
        no-autogen: true
        make-install-args:
          - libdir=/app/lib
          - libexecdir=/app/lib
          - includedir=/app/include
          - mandir=/app/share/man
        sources:
          - type: archive
            url: ftp://ftp.altlinux.org/pub/people/ldv/utempter/libutempter-1.2.1.tar.gz
            sha256: 967fef372f391de501843ad87570c6cf5dabd9651f00f1783090fbc12b2a34cb
      - name: libevent
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/libevent/libevent/releases/download/release-2.1.12-stable/libevent-2.1.12-stable.tar.gz
            sha256: 92e6de1be9ec176428fd2367677e61ceffc2ee1cb119035037a27d346b0403bb
        cleanup:
          - /lib/cmake
  - name: byobu
    sources:
      - type: archive
        url: https://launchpad.net/byobu/trunk/5.133/+download/byobu_5.133.orig.tar.gz
        sha256: 4d8ea48f8c059e56f7174df89b04a08c32286bae5a21562c5c6f61be6dab7563
      - type: shell
        commands:
          - |
              sed -i 's#^\(SOCKETDIR\)=.*#\1=/tmp/screens#' etc/byobu/socketdir
    modules:
      # TODO: test byobu features that each of these libs add
      - name: libnewt
        sources:
          - type: archive
            url: https://releases.pagure.org/newt/newt-0.52.21.tar.gz
            sha256: 265eb46b55d7eaeb887fca7a1d51fe115658882dfe148164b6c49fccac5abb31
        modules:
          - name: slang
            no-parallel-make: true
            config-opts:
              - --with-pcreinc=/usr/include
              - --with-pcrelib=/usr/lib/x86_64-linux-gnu
            sources:
              - type: archive
                url: https://www.jedsoft.org/releases/slang/slang-2.3.2.tar.bz2
                sha256: fc9e3b0fc4f67c3c1f6d43c90c16a5c42d117b8e28457c5b46831b8b5d3ae31a
          - name: libxcrypt
            config-opts:
              - --disable-static
              - --disable-failure-tokens
              - --enable-hashes=strong,glibc
              - --enable-obsolete-api=no
            sources:
              - type: archive
                url: https://github.com/besser82/libxcrypt/archive/v4.4.17.tar.gz
                sha256: 7665168d0409574a03f7b484682e68334764c29c21ca5df438955a381384ca07
          - name: gpm
            config-opts:
              - --sbindir=/app/bin
              - --sysconfdir=/app/etc
            sources:
              - type: git
                url: https://github.com/telmich/gpm.git
                commit: e82d1a653ca94aa4ed12441424da6ce780b1e530
  - name: finish
    buildsystem: simple
    build-commands:
      - install -Dm644 com.github.thestinger.termite.byobu.desktop -t /app/share/applications
      - install -Dm644 /app/share/byobu/pixmaps/byobu.svg
          /app/share/icons/hicolor/scalable/apps/com.github.thestinger.termite.byobu.svg
    sources:
      - type: dir
        path: resources
