# TODO
#   Fix tray icons
#   Fix xdg-open, probably just need to set default file browser
#   Somehow remap the socket /tmp/insync1000.sock
#     maybe create the socket somewhere with nc -lkU before startup and symlink it to /tmp
#   Add an example extension for dolphin
#   Clean the manifest
#   Install desktop file

app-id: com.insynchq.insync
# needed for notifications that are not working with the freedesktop runtime
runtime: org.gnome.Platform
runtime-version: '3.36'
sdk: org.gnome.Sdk
command: insync
#rename-icon: insync
#rename-appdata-file: insync.appdata.xml  
#rename-desktop-file: insync.desktop
#copy-icon: true
finish-args:
  # Wayland access
  - --socket=wayland
  # X11 + XShm access
  - --socket=x11
  - --share=ipc
  # OpenGL access
  - --device=dri

  - --filesystem=home

  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  # Network access
  - --share=network
  - --persist=.config/autostart
  - --persist=.config/Insync
cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/man
  - '*.a'
  - '*.la'
cleanup-commands: # https://github.com/flatpak/flatpak-builder/issues/233
  - rm -rf /app/{include,lib/{cmake,mkspecs,pkgconfig}}

modules:

- name: libbsd
  buildsystem: simple
  build-commands:
    - './configure --prefix=/app'
    - 'make'
    - 'make install'
  sources:
    - type: archive
      url: https://libbsd.freedesktop.org/releases/libbsd-0.10.0.tar.xz
      sha256: 34b8adc726883d0e85b3118fa13605e179a62b31ba51f676136ecb2d0bc1a887
- name: openbsd-netcat
  buildsystem: simple
  build-commands:
    - ls -l
    - 'for i in `cat patches/series`; do echo "** patch $i" 1>&2; cat "patches/$i"; done | patch -p1'
    - 'make CFLAGS="$CFLAGS -I/app/include/libbsd" LDFLAGS="$LDFLAGS -lbsd"'
    - 'install -Dm0755 nc /app/bin/nc'
  sources:
    - type: archive
      url: http://ftp.debian.org/debian/pool/main/n/netcat-openbsd/netcat-openbsd_1.206.orig.tar.gz
      sha256: 5153e19521b648657e1098641c86d4c02f92aff4a64d549ae328f0d738df03e7
    - type: archive
      url: http://ftp.debian.org/debian/pool/main/n/netcat-openbsd/netcat-openbsd_1.206-1.debian.tar.xz
      sha256: 917e08ad15583a631a19841dcced69a4e43aa190bc4be93e93034bebd16fc51a

- name: insync
  buildsystem: simple
  build-commands: [
      "install -D apply_extra /app/bin/apply_extra",
      "install -D insync /app/bin/insync",
      "install -D insync.svg /app/share/icons/hicolor/scalable/apps/com.insynchq.insync.svg",
      "install -D *insync-*.png -t /app/share/icons/hicolor/48x48/status",
      "cp /usr/bin/ar /app/bin",
      "mkdir -p /app/lib",
      "ARCH_TRIPLE=$(gcc --print-multiarch) && cp /usr/lib/${ARCH_TRIPLE}/libbfd-*.so /app/lib",
      "ARCH_TRIPLE=$(gcc --print-multiarch) && ln -s /usr/lib/${ARCH_TRIPLE}/libcurl.so.4.5.0 /app/lib/libcurl-gnutls.so.4"
                  ]
  sources:
    - type: script
      dest-filename: apply_extra
      commands: [
              "ar x insync.deb",
              "rm -f insync.deb",
              "tar xf data.tar.gz",
              "rm -f control.tar.gz data.tar.gz debian-binary",
              "mv usr/* .",
              "rmdir usr",
              "install /app/share/icons/hicolor/48x48/status/com.insynchq.insync-*.png -t share/icons/hicolor/48x48/status"
              ]
    - type: file
      path: com.insynchq.insync.desktop
    - type: file
      path: insync
    - type: file
      path: insync.svg
    - type: dir
      path: status-icons
    - type: extra-data
      filename: insync.deb
      url: http://s.insynchq.com/builds/insync_3.1.5.40801-buster_amd64.deb
      sha256: 9ee11a19871d540ed4c2a485e7a170c68c4e9ba975cf08e8369ce807ec5a1018
      size: 143070478
