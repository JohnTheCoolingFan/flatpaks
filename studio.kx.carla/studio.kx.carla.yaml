app-id: studio.kx.carla
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
add-extensions:
  # details in org.freedesktop.LinuxAudio.BaseExtension
  org.freedesktop.LinuxAudio.Plugins:
    directory: extensions/Plugins
    version: '20.08'
    add-ld-path: lib
    merge-dirs: ladspa;dssi;lv2;lxvst;vst3
    subdirectories: true
    no-autodownload: true
command: carla
finish-args:
  - --device=dri
  # TODO: figure out how to make it work, carla env parsing seems to be broken
  - --env=DSSI_PATH=/app/extensions/Plugins/dssi
  - --env=LADSPA_PATH=/app/extensions/Plugins/ladspa
  - --env=LV2_PATH=/app/extensions/Plugins/lv2
  - --env=LXVST_PATH=/app/extensions/Plugins/lxvst
  - --env=VST3_PATH=/app/extensions/Plugins/vst3
  - --filesystem=xdg-run/pipewire-0:ro
  - --share=ipc
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
modules:
  - name: carla
    no-autogen: true
    make-args:
      # carla is too much out-of-date to build against ffmpeg
      #- HAVE_FFMPEG=true
      - HAVE_PYQT=true
      # enable this?
      - USING_JUCE=false
    make-install-args:
      - PREFIX=/app
    post-install:
      - install -dm755 /app/extensions/Plugins
    sources:
      - type: archive
        url: https://github.com/falkTX/Carla/archive/v2.2.0.tar.gz
        sha256: 4bf08511257db88979eccc002f10c153ff2a14f5143291c2be39cadd69ce10e1
      - type: shell
        commands:
          - |
            make features \
              HAVE_PYQT=true \
              USING_JUCE=false
              #HAVE_FFMPEG=true \
    modules:
      # TODO: move out to a shared module
      - name: pyqt5
        config-opts:
          - --assume-shared
          - --concatenate
          - --confirm-license
          - --enable=QtCore
          - --enable=QtGui
          - --enable=QtNetwork
          - --enable=QtOpenGL
          - --enable=QtPrintSupport
          - --enable=QtQml
          - --enable=QtQuick
          - --enable=QtSql
          - --enable=QtSvg
          - --enable=QtWebChannel
          - --enable=QtWidgets
          - --no-designer-plugin
          - --no-dist-info
          - --no-docstrings
          - --no-qml-plugin
          - --no-qsci-api
          - --no-stubs
          - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.8/'
          - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.8/'
        sources:
          - type: archive
            url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.15.4.tar.gz
            sha256: 2a69597e0dd11caabe75fae133feca66387819fc9bc050f547e5551bce97e5be
          - type: script
            commands:
            - processed=`sed -e 's|prefix|sysroot|' <<< $@`
            - python3 configure.py $processed
            dest-filename: configure
        cleanup:
          - /lib/debug
          - /share/sip
        modules:
          - name: sip
            config-opts:
              - --no-dist-info
              - --no-stubs
              - --bindir=/app/bin
              - --destdir=/app/lib/python3.8/site-packages
              - --incdir=/app/include
              - --pyidir=/app/lib/python3.8/site-packages
              - --sipdir=/app/share/sip
              - --sip-module PyQt5.sip
            sources:
              - type: archive
                url: https://www.riverbankcomputing.com/static/Downloads/sip/4.19.25/sip-4.19.25.tar.gz
                sha256: b39d93e937647807bac23579edbff25fe46d16213f708370072574ab1f1b4211
              - type: script
                commands:
                  - processed=`sed -e 's|--prefix=/app||' <<< $@`
                  - python3 configure.py $processed
                dest-filename: configure
            cleanup:
              - /bin
              - /include
      - name: liblo
        sources:
          - type: archive
            url: https://github.com/radarsat1/liblo/archive/0.31.tar.gz
            sha256: 71d1819bcd18be66bd80c95a2d3159b9ca6f13746ddbaf1e489128f3bf46d231
      - ../shared-modules/pipewire/pipewire-jack.json
      # TODO: drop this completely or figure out how to build against ffmpeg
      #- ../shared-modules/ffmpeg/ffmpeg.json
      # TODO: enable features and cleanup
      # TODO: move out to a shared module with pipewire-jack and other dependencies, also package liblo with it
      - name: fluidsynth
        buildsystem: cmake
        config-opts:
          - -DLIB_SUFFIX=''
        sources:
          - type: archive
            url: https://github.com/FluidSynth/fluidsynth/archive/refs/tags/v2.1.8.tar.gz
            sha256: a254efceff5d99f8d658d12d25318317f37307e6df852ec9baeb7da173496967
