app-id: org.winehq.wine
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386
add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: '21.08'
  org.freedesktop.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: '21.08'
    no-autodownload: true
x-compat-i386-opts: &compat_i386_opts
  prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
  ldflags: -L/app/lib32
  prepend-path: /usr/lib/sdk/toolchain-i386/bin
  env:
    CC: i686-unknown-linux-gnu-gcc
    CXX: i686-unknown-linux-gnu-g++
  libdir: /app/lib32
command: /bin/sh
finish-args:
  - --allow=multiarch
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
cleanup:
  - /include
modules:
  - name: wine
    buildsystem: simple
    build-commands:
      - install -dm755 /app/lib/i386-linux-gnu
      - |
        install -Dm644 /dev/stdin /app/etc/ld.so.conf <<EOF
        /app/lib32
        /app/lib/i386-linux-gnu
        EOF
      - cp -R --preserve=timestamps /app/src/wine64 .
      - make -C wine64 install
    modules:
      # TODO: add missing modules
      # - name: libgphoto2
      # - name: samba
      # - name: sane
      - ../shared-modules/glu/glu.json
      - ../shared-modules/glu/lib32-glu.json
      - ../shared-modules/gsm/gsm.json
      - ../shared-modules/libjpeg-turbo/lib32-libjpeg-turbo.json
      - ../shared-modules/libjpeg-turbo/libjpeg-turbo.json
      - ../shared-modules/libpcap/lib32-libpcap.json
      - ../shared-modules/libpcap/libpcap.json
      - ../shared-modules/libxmu/lib32-libxmu.json
      - ../shared-modules/libxmu/libxmu.json
      - ../shared-modules/opencl-headers/opencl-headers.json
      - ../shared-modules/openldap/lib32-openldap.json
      - ../shared-modules/openldap/openldap.json
      - faudio/faudio.json
      - faudio/lib32-faudio.json
      - vkd3d/lib32-vkd3d.json
      - vkd3d/vkd3d.json
      - name: wine64
        no-make-install: true
        config-opts:
          - --enable-win64
          - --libdir=/app/lib
          - --with-ldap
          - --with-x
          - --with-wayland
        build-commands:
          - mkdir -p /app/src
          - cp -r $FLATPAK_BUILDER_BUILDDIR /app/src/wine64
        sources:
#         - type: archive
#           url: https://dl.winehq.org/wine/source/6.x/wine-6.3.tar.xz
#           sha256: 682a77c1fd12f56347ca2080d85fe17def1b655d3241d94582f87591d9d0cc3b
#           x-checker-data:
#             type: anitya
#             project-id: 5134
#             stable-only: true
#             url-template: https://dl.winehq.org/wine/source/$version0.x/wine-$version.tar.xz
          - type: git
            url: https://gitlab.collabora.com/alf/wine.git
            branch: wayland
            commit: 5affac5c26f8a138063a186ddfe070cf6641c68a
        cleanup:
          - /share/applications
          - /share/man/*.UTF-8
          - /src
      - name: wine32
        config-opts:
          - --with-win64=/app/src/wine64
          - --with-x
          - --with-wayland
        build-options:
          arch:
            x86_64: *compat_i386_opts
        sources:
#         - type: archive
#           url: https://dl.winehq.org/wine/source/6.x/wine-6.3.tar.xz
#           sha256: 682a77c1fd12f56347ca2080d85fe17def1b655d3241d94582f87591d9d0cc3b
#           x-checker-data:
#             type: anitya
#             project-id: 5134
#             stable-only: true
#             url-template: https://dl.winehq.org/wine/source/$version0.x/wine-$version.tar.xz
          - type: git
            url: https://gitlab.collabora.com/alf/wine.git
            branch: wayland
            commit: 5affac5c26f8a138063a186ddfe070cf6641c68a
        cleanup:
          - /share/applications
          - /share/man/*.UTF-8
  # TODO: add dosbox
  # - dosbox/dosbox.json
  # 7z can extract some self-extract *.exe installers
  - ../shared-modules/p7zip/p7zip.json
  - dxvk/dxvk-bin.json
  - wine-gecko/wine-gecko.json
  - wine-mono/wine-mono.json
  - winetricks/winetricks.json
