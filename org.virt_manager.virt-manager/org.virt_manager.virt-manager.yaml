# Known issues:
#  * ~/.ssh is not saved between running sessions
#    you might need to override it with:
#      --filesystem=~/.ssh which bind mount the folder from the host to the container
#    or with:
#      --persist=.ssh which saves the folder content between running sessions.
#    i prefer the latter as on my host i use a patched openssh build with the user dir at ~/.config/ssh,
#    and instead of giving direct access to my ssh key files  i'm sharing the ssh-agent pid and socket
#    with the container by bind mounting xdg-run/ssh.
#  * i haven't tested much of the features of virt-manager yet so there might be other issues.

app-id: org.virt_manager.virt-manager
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: virt-manager
rename-icon: virt-manager
rename-desktop-file: virt-manager.desktop
finish-args:
  - --device=dri
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-public-share
  - --filesystem=xdg-videos
  # unix socket access
  - --filesystem=/run/libvirt
  # ssh-agent pid and socket
  #- --filesystem=xdg-run/ssh
  - --own-name=org.virt-manager.virt-manager
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
# - --talk-name=org.freedesktop.Notifications
# - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/bash-completion
  - /share/icons/hicolor/icon-theme.cache
  - /share/man
  - '*.la'
modules:
  - name: libvirt
    buildsystem: meson
    build-options:
      cflags: -I/app/include/tirpc
    config-opts:
      - --libexec=/app/lib/libvirt
      - --sbindir=/app/bin
      - --localstatedir=/var
      - -Drunstatedir=/run
      - -Drpath=enabled
      - -Dqemu_group=kvm
      # python-libvirt need libvirt-api.xml
      - -Ddocs=enabled
      - -Dtests=disabled
      - -Dstorage_mpath=disabled
      - -Dfirewalld=disabled
      - -Dfirewalld-zone=disabled
      - -Dinit_script=none
      - -Dsysctl_config=disabled
    sources:
      - type: archive
        url: https://libvirt.org/sources/libvirt-7.2.0.tar.xz
        sha256: 01f459d0c7ba5009622a628dba1a026200e8f4a299fea783b936a71d7e0ed1d0
    cleanup:
      - /etc/logrotate.d
      - /share/doc
    modules:
      - ../shared-modules/libnl/libnl.json
      - name: python-docutils
        buildsystem: simple
        build-commands:
          - python3 setup.py build
          - python3 setup.py install --root=/ --prefix=app/
        sources:
          - type: archive
            url: http://downloads.sourceforge.net/docutils/docutils-0.16.tar.gz
            sha256: 7d4e999cca74a52611773a42912088078363a30912e8822f7a3d38043b767573
        cleanup:
          - '*'
      - name: rpcsvc-proto
        sources:
          - type: archive
            url: https://github.com/thkukuk/rpcsvc-proto/archive/v1.4.2.tar.gz
            sha256: 9f309fa25507836b0c5de8a9d755c1428bde5554610bf92eb21e32078134aef5
          - type: script
            dest-filename: autogen.sh
            commands:
              - autoreconf -fi
        cleanup:
          - '*'
      - ../shared-modules/libtirpc/libtirpc.json
  - name: libvirt-glib
    buildsystem: meson
    config-opts:
      - -Drpath=enabled
      - -Ddocs=disabled
      - -Dtests=disabled
      - -Dintrospection=enabled
      - -Dvapi=disabled
    sources:
      - type: archive
        url: https://libvirt.org/sources/glib/libvirt-glib-4.0.0.tar.xz
        sha256: 8423f7069daa476307321d1c11e2ecc285340cd32ca9fc05207762843edeacbd
    cleanup:
      - /share/gtk-doc
    modules:
      - name: libcap-ng
        config-opts:
          - --enable-static=no
        sources:
          - type: archive
            url: https://github.com/stevegrubb/libcap-ng/archive/v0.8.2.tar.gz
            sha256: 65b86885b8d873e55c05bd49427fd370d559b26f0c2089ac9194828e6a2fe233
        cleanup:
          - /bin
          - /share/aclocal
  - name: gtk-vnc
    # TODO: bump to latest commit and test zoom levels
    buildsystem: meson
    config-opts:
      - -Dwith-vala=false
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/gtk-vnc/-/archive/v1.0.0/gtk-vnc-v1.0.0.tar.gz
        sha256: fca1d84d9430d4efd510c65f1270f27025ceb5c6cb9ebc8a8cc585450ebe97d8
      - type: archive
        url: https://gitlab.com/keycodemap/keycodemapdb/-/archive/6280c94f306df6a20bbc100ba15a5a81af0366e6/keycodemapdb-6280c94f306df6a20bbc100ba15a5a81af0366e6.tar.gz
        sha256: eec0777e0bf5efd2548881f820f2d36daa86effb4af43d5b2fb5c4541b747f55
        dest: subprojects/keycodemapdb
  - name: spice-gtk
    buildsystem: meson
    config-opts:
      - -Dcelt051=disabled
      - -Dgtk_doc=disabled
      - -Dvapi=disabled
    sources:
      - type: archive
        url: https://www.spice-space.org/download/gtk/spice-gtk-0.39.tar.xz
        sha256: 23acbee197eaaec9bce6e6bfd885bd8f79708332639243ff04833020865713cd
    modules:
      - name: python-pyparsing
        buildsystem: simple
        build-commands:
          - python3 setup.py build
          - python3 setup.py install --root=/ --prefix=app/
        sources:
          - type: archive
            url: https://github.com/pyparsing/pyparsing/archive/pyparsing_2.4.7.tar.gz
            sha256: 6deecf4b95a49a5a9c89b4a4b1fcb73c1cba0e3265ec7b858adffcced229ba05
        cleanup:
          - '*'
      - name: libcacard
        sources:
          - type: archive
            url: https://www.spice-space.org/download/libcacard/libcacard-2.7.0.tar.xz
            sha256: 16b1a0847d5f9d2290e0785eca40f2e49d1ed80814bfc758c05c76b3c89cdb6f
      - name: phodav
        buildsystem: meson
        config-opts:
          - -Dgtk_doc=disabled
          - -Dsystemd=disabled
          - -Dudev=disabled
          - -Dsbindir=bin
        sources:
          - type: archive
            url: https://download.gnome.org/sources/phodav/2.5/phodav-2.5.tar.xz
            sha256: 71f0a9cd70afd4dd1412a0298331dbb8ac71c0377f52117afc15eb88dc6fb910
      - ../flathub-shared-modules/libusb/libusb.json
      - name: usbredir
        config-opts:
          - --enable-static=no
          - --sbindir=/app/bin
        sources:
          - type: archive
            url: https://spice-space.org/download/usbredir/usbredir-0.9.0.tar.xz
            sha256: a3e167bf42bc7fe02c3c9db27d7767f1b8ce41b99ad14a4b0d0a60abe8bf56a6
      - name: usbutils
        config-opts:
          - --datadir=/app/share/hwdata
          - --disable-zlib
        sources:
          - type: archive
            url: https://www.kernel.org/pub/linux/utils/usb/usbutils/usbutils-013.tar.xz
            sha256: 9e23494fcc78b7a80ee29a07dd179c95ae2f71509c35728dbbabc2d1cca41338
        modules:
          - name: hwids
            buildsystem: simple
            build-commands:
              - for ids in pci.ids usb.ids; do install -Dm644 "$ids" /app/share/hwdata/${ids}; done
            sources:
              - type: archive
                url: https://github.com/gentoo/hwids/archive/hwids-20201207.tar.gz
                sha256: 43a8af154769c33871582caea31546a8b91cefb6f0acdf53d08660237ae57e37
    # TODO
    #   meson doesn't find usbutils
    #   add polkit-gobject?
      - name: spice-protocol
        buildsystem: meson
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/spice/spice-protocol/-/archive/v0.14.3/spice-protocol-v0.14.3.tar.gz
            sha256: 80ae89643e253dc5ddc5b2120cd3cf9d9565d00026ff261dd140d4b8c5deaa64
  - name: libgovirt
    config-opts:
      - --enable-static=no
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libgovirt/-/archive/v0.3.7/libgovirt-v0.3.8.tar.gz
        sha256: a391df1503a5c72fa42f4b3ff0cea9cb20487b61668634922efc1be7186325c5
    modules:
      - name: rest
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/librest/-/archive/0.8.1/librest-0.8.1.tar.gz
            sha256: 2bdd1be07a9150b1c6ceea6e01dedf2efcff564381cae0cd6c7330403efe59d7
  - name: libvirt-python
    buildsystem: simple
    build-commands:
      - python3 setup.py clean
      - python3 setup.py install --root=/ --prefix=app/
    sources:
      - type: archive
        url: https://libvirt.org/sources/python/libvirt-python-7.2.0.tar.gz
        sha256: c0c3bac54c55622e17927b09cd9843869600d71842fb072c99491fe2608dcee7
  - ../flathub-shared-modules/intltool/intltool-0.51.json
  - name: virt-manager
    buildsystem: simple
    build-commands:
      - python3 setup.py configure --prefix=/app
      - python3 setup.py build
      - python3 setup.py install --root /
#     - ln -s ../../var/run /app/var/run
#     - python3 setup.py --no-update-icon-cache --no-compile-schemas install --root /
#     - python3 -m compileall /app/share/virt-manager
#     - python3 -O -m compileall /app/share/virt-manager
    sources:
      - type: archive
        url: https://github.com/virt-manager/virt-manager/archive/v3.2.0.tar.gz
        sha256: 74bf899e25ef2751e6b9b7b46a4e79760cd3e8adb5a5fc474944507a4587e0fd
      - type: patch
        path: virt-manager-disable-man-pages.patch
    modules:
      - ../shared-modules/python-gobject/python-gobject.json
      - ../shared-modules/gtksourceview4/gtksourceview4.json
      - ../shared-modules/vte3/vte3.json
      - virt-manager-python-dependencies.json
      - name: libosinfo
        buildsystem: meson
        config-opts:
          - -Dwith-usb-ids-path=/app/share/hwdata/usb.ids
          - -Dwith-pci-ids-path=/app/share/hwdata/pci.ids
        sources:
          - type: archive
            url: https://releases.pagure.org/libosinfo/libosinfo-1.9.0.tar.xz
            sha256: b4f3418154ef3f43d9420827294916aea1827021afc06e1644fc56951830a359
        cleanup:
          - /share/gtk-doc
          - /share/vala
        modules:
          - name: osinfo-db
            buildsystem: simple
            build-commands:
              - osinfo-db-import --system osinfo-db.tar.xz
            sources:
              - type: file
                url: https://releases.pagure.org/libosinfo/osinfo-db-20210312.tar.xz
                sha256: 7548ec09e445ca7378c5ceb99e39edca8857f8293831e0b3cb558f4230870e10
                dest-filename: osinfo-db.tar.xz
            modules:
              - name: osinfo-db-tools
                buildsystem: meson
                sources:
                  - type: archive
                    url: https://releases.pagure.org/libosinfo/osinfo-db-tools-1.9.0.tar.xz
                    sha256: 255f1c878bacec70c3020ff5a9cb0f6bd861ca0009f24608df5ef6f62d5243c0
                cleanup:
                  - '*'
  - name: virt-viewer
    post-install:
      - |
          _MODULE_ID=virt-viewer
          _FP_MOD_URI=${FLATPAK_ID}.${_MODULE_ID}
          cd /app/share

          pushd applications
          mv remote-viewer.desktop ${_FP_MOD_URI}.desktop
          desktop-file-edit --set-icon=${_FP_MOD_URI} ${_FP_MOD_URI}.desktop
          popd

          pushd icons/hicolor
          for f in $(find ./ -name "${_MODULE_ID}.png" -o -name "${_MODULE_ID}.svg"); do
            mv ${f} $(dirname $f)/${_FP_MOD_URI}.${f##*.}
          done
          popd

          mv mime/packages/${_MODULE_ID}-mime.xml mime/packages/${_FP_MOD_URI}-mime.xml
    sources:
      - type: archive
        url: https://virt-manager.org/download/sources/virt-viewer/virt-viewer-9.0.tar.gz
        sha256: 91b43383a0bd4cf3173269e674d65fd205f7c34bc5a8cb4fb3640deb7f1d4825
