# Known issues:
#  * ~/.ssh is not saved between running sessions
#    you might need to override it with:
#      --filesystem=~/.ssh which bind mount the folder from the host to the container
#    or with:
#      --persist=.ssh which saves the folder content between running sessions.
#    i prefer the latter as on my host i use a patched openssh build with the user dir at ~/.config/ssh,
#    and instead of giving direct access to my ssh key files  i'm sharing the ssh-agent pid and socket
#    with the container by bind mounting xdg-run/ssh.
#  * i haven't tested much of the features of virt-manager yet so there might be other issues.

app-id: org.virt_manager.virt-manager
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: virt-manager
rename-icon: virt-manager
rename-desktop-file: virt-manager.desktop
finish-args:
  - --device=dri
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-public-share
  - --filesystem=xdg-videos
  # unix socket access
  - --filesystem=/run/libvirt
  # ssh-agent pid and socket
  #- --filesystem=xdg-run/ssh
  - --own-name=org.virt-manager.virt-manager
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
# - --talk-name=org.freedesktop.Notifications
# - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/bash-completion
  - /share/icons/hicolor/icon-theme.cache
  - /share/man
  - '*.la'
modules:
  - name: libvirt
    builddir: true
    config-opts:
      - --libexec=/app/lib/libvirt
      - --sbindir=/app/bin
      - --with-runstatedir=/run
      - --localstatedir=/var
      - --with-qemu-group=kvm
      - with_storage_mpath=no
      - CFLAGS=-I/app/include/tirpc
      - --with-firewalld=no
      - --with-firewalld-zone=no
      - --with-sysctl=no
    sources:
      - type: archive
        url: https://libvirt.org/sources/libvirt-6.4.0.tar.xz
        sha256: 586ebcf220369d08a07c6cc17035e8a91bb3741e4300199459904e9e02478be7
      - type: shell
#       commands:
#         - find ./ -name Makefile.inc.am -exec sed -i '/.*$(MKDIR_P).*$(DESTDIR)$(localstatedir).*/d' {} \;
#         - find ./ -name Makefile.inc.am -exec sed -i '/.*$(MKDIR_P).*$(DESTDIR)$(runstatedir).*/d' {} \;
#         - sed '/case $lv_cv_xdr_cflags in/i     lv_cv_xdr_cflags=-I/app/include/tirpc' -i configure
    cleanup:
      - /etc/logrotate.d
      - /share/doc
    modules:
      - ../shared-modules/libnl/libnl.json
      - name: python-docutils
        buildsystem: simple
        build-commands:
          - python3 setup.py build
          - python3 setup.py install --root=/ --prefix=app/
        sources:
          - type: archive
            url: http://downloads.sourceforge.net/docutils/docutils-0.16.tar.gz
            sha256: 7d4e999cca74a52611773a42912088078363a30912e8822f7a3d38043b767573
        cleanup:
          - '*'
      - name: rpcsvc-proto
        sources:
          - type: archive
            url: https://github.com/thkukuk/rpcsvc-proto/archive/v1.4.1.tar.gz
            sha256: 750f7e57b81407a25b707867e90d7ee80aeb53bf515b114fc218f3c78dc9a6e8
        cleanup:
          - '*'
      - ../shared-modules/libtirpc/libtirpc.json
  - name: libvirt-glib
    config-opts:
      - --enable-vala=no
    sources:
      - type: archive
        url: https://libvirt.org/sources/glib/libvirt-glib-3.0.0.tar.gz
        sha256: 7fff8ca9a2b723dbfd04223b1c7624251c8bf79eb57ec27362a7301b2dd9ebfe
    cleanup:
      - /share/gtk-doc
    modules:
      - name: libcap-ng
        config-opts:
          - --enable-static=no
        sources:
          - type: archive
            url: https://github.com/stevegrubb/libcap-ng/archive/v0.7.10.tar.gz
            sha256: c3c156a215e5be5430b2f3b8717bbd1afdabe458b6068a8d163e71cefe98fc32
        cleanup:
          - /bin
          - /share/aclocal
  - name: gtk-vnc
    buildsystem: meson
    config-opts:
      - -Dwith-vala=false
    sources:
      - type: git
        url: https://gitlab.gnome.org/GNOME/gtk-vnc.git
        tag: v1.0.0
    #modules:
    #  - name: perl-text-csv
  - name: spice-gtk
    buildsystem: meson
    config-opts:
      - -Dcelt051=disabled
      - -Dgtk_doc=disabled
      - -Dvapi=disabled
    sources:
      - type: archive
        url: https://www.spice-space.org/download/gtk/spice-gtk-0.38.tar.xz
        sha256: 5ae974731baf2b41316d4f0b3ae0c2e47f00bff91a5a617e189cd3dedcd96d8e
    modules:
      - name: python-pyparsing
        buildsystem: simple
        build-commands:
          - python3 setup.py build
          - python3 setup.py install --root=/ --prefix=app/
        sources:
          - type: archive
            url: https://github.com/pyparsing/pyparsing/archive/pyparsing_2.4.7.tar.gz
            sha256: 6deecf4b95a49a5a9c89b4a4b1fcb73c1cba0e3265ec7b858adffcced229ba05
        cleanup:
          - '*'
      - name: libcacard
        sources:
          - type: archive
            url: https://www.spice-space.org/download/libcacard/libcacard-2.7.0.tar.xz
            sha256: 16b1a0847d5f9d2290e0785eca40f2e49d1ed80814bfc758c05c76b3c89cdb6f
      - name: phodav
        buildsystem: meson
        config-opts:
          - -Dgtk_doc=disabled
          - -Dsystemd=disabled
          - -Dudev=disabled
          - -Dsbindir=bin
        sources:
          - type: archive
            url: https://download.gnome.org/sources/phodav/2.4/phodav-2.4.tar.xz
            sha256: 7dddc2b75e04d0866bb9c9a83028a597ebd73ef4c37bd6ebe1032a870b43b8c3
          - type: shell
      - ../flathub-shared-modules/libusb/libusb.json
      - name: usbredir
        config-opts:
          - --enable-static=no
          - --sbindir=/app/bin
        sources:
          - type: archive
            url: https://spice-space.org/download/usbredir/usbredir-0.8.0.tar.bz2
            sha256: 87bc9c5a81c982517a1bec70dc8d22e15ae197847643d58f20c0ced3c38c5e00
      - name: usbutils
        config-opts:
          - --datadir=/app/share/hwdata
          - --disable-zlib
        sources:
          - type: archive
            url: https://www.kernel.org/pub/linux/utils/usb/usbutils/usbutils-012.tar.xz
            sha256: 88634625f91840bc1993d2731cc081ee8d3b13d56069a95bdd6ac6ef0e063e46
        modules:
          - name: hwids
            buildsystem: simple
            build-commands:
              - for ids in pci.ids usb.ids; do install -Dm644 "$ids" /app/share/hwdata/${ids}; done
            sources:
              - type: git
                url: https://github.com/gentoo/hwids.git
                tag: hwids-20200306
    # TODO
    #   meson doesn't find usbutils
    #   add polkit-gobject?
      - name: spice-protocol
        buildsystem: meson
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/spice/spice-protocol/-/archive/v0.14.1/spice-protocol-v0.14.1.tar.gz
            sha256: 67d8842de66f02dfa7ec512d607dc99164b465ee6772d48782f1de935cb19ee6
  - name: libgovirt
    config-opts:
      - --enable-static=no
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libgovirt/-/archive/v0.3.7/libgovirt-v0.3.7.tar.gz
        sha256: c7311f8c4518fe8407bfe5bf7de3d84a548ddb41943cc64670821abfaec98fd8
    modules:
      - name: rest
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/librest/-/archive/0.8.1/librest-0.8.1.tar.gz
            sha256: 2bdd1be07a9150b1c6ceea6e01dedf2efcff564381cae0cd6c7330403efe59d7
  - name: libvirt-python
    buildsystem: simple
    build-commands:
      - python3 setup.py clean
      - python3 setup.py install --root=/ --prefix=app/
    sources:
      - type: archive
        url: https://libvirt.org/sources/python/libvirt-python-6.4.0.tar.gz
        sha256: b13e6dddea8876a7a6c43482d275a84f082d72427302ecb76683c1279b865cec
  - ../flathub-shared-modules/intltool/intltool-0.51.json
  - name: virt-manager
    buildsystem: simple
    build-commands:
      - python3 setup.py configure --prefix=/app
      - python3 setup.py build
      - python3 setup.py install --root /
#     - ln -s ../../var/run /app/var/run
#     - python3 setup.py --no-update-icon-cache --no-compile-schemas install --root /
#     - python3 -m compileall /app/share/virt-manager
#     - python3 -O -m compileall /app/share/virt-manager
    sources:
      - type: archive
        url: https://github.com/virt-manager/virt-manager/archive/v3.2.0.tar.gz
        sha256: 74bf899e25ef2751e6b9b7b46a4e79760cd3e8adb5a5fc474944507a4587e0fd
      - type: patch
        path: virt-manager-disable-man-pages.patch
    modules:
      - ../shared-modules/python-gobject/python-gobject.json
      - ../shared-modules/gtksourceview4/gtksourceview4.json
      - ../shared-modules/vte3/vte3.json
      - virt-manager-python-dependencies.json
      - name: libosinfo
        buildsystem: meson
        config-opts:
          - -Dwith-usb-ids-path=/app/share/hwdata/usb.ids
          - -Dwith-pci-ids-path=/app/share/hwdata/pci.ids
        sources:
          - type: archive
            url: https://releases.pagure.org/libosinfo/libosinfo-1.9.0.tar.xz
            sha256: b4f3418154ef3f43d9420827294916aea1827021afc06e1644fc56951830a359
        cleanup:
          - /share/gtk-doc
          - /share/vala
        modules:
          - name: osinfo-db
            buildsystem: simple
            build-commands:
              - osinfo-db-import --system osinfo-db.tar.xz
            sources:
              - type: file
                url: https://releases.pagure.org/libosinfo/osinfo-db-20210312.tar.xz
                sha256: 7548ec09e445ca7378c5ceb99e39edca8857f8293831e0b3cb558f4230870e10
                dest-filename: osinfo-db.tar.xz
            modules:
              - name: osinfo-db-tools
                buildsystem: meson
                sources:
                  - type: archive
                    url: https://releases.pagure.org/libosinfo/osinfo-db-tools-1.9.0.tar.xz
                    sha256: 255f1c878bacec70c3020ff5a9cb0f6bd861ca0009f24608df5ef6f62d5243c0
                cleanup:
                  - '*'
  - name: virt-viewer
    post-install:
      - |
          _MODULE_ID=virt-viewer
          _FP_MOD_URI=${FLATPAK_ID}.${_MODULE_ID}
          cd /app/share

          pushd applications
          mv remote-viewer.desktop ${_FP_MOD_URI}.desktop
          desktop-file-edit --set-icon=${_FP_MOD_URI} ${_FP_MOD_URI}.desktop
          popd

          pushd icons/hicolor
          for f in $(find ./ -name "${_MODULE_ID}.png" -o -name "${_MODULE_ID}.svg"); do
            mv ${f} $(dirname $f)/${_FP_MOD_URI}.${f##*.}
          done
          popd

          mv mime/packages/${_MODULE_ID}-mime.xml mime/packages/${_FP_MOD_URI}-mime.xml
    sources:
      - type: archive
        url: https://virt-manager.org/download/sources/virt-viewer/virt-viewer-8.0.tar.gz
        sha256: dcf358ed5d7a4900215133135a6492c04311d84332816d930df9a89d6195b6ed
