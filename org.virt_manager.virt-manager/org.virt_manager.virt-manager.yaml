# Known issues:
#  * ~/.ssh is not saved between running sessions
#    you might need to override it with:
#      --filesystem=~/.ssh which bind mount the folder from the host to the container
#    or with:
#      --persist=.ssh which saves the folder content between running sessions.
#    i prefer the latter as on my host i use a patched openssh build with the user dir at ~/.config/ssh,
#    and instead of giving direct access to my ssh key files  i'm sharing the ssh-agent pid and socket
#    with the container by bind mounting xdg-run/ssh.
#  * i haven't tested much of the features of virt-manager yet so there might be other issues.

app-id: org.virt_manager.virt-manager
base: org.libvirt.libvirt.BaseApp
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: virt-manager
rename-icon: virt-manager
rename-desktop-file: virt-manager.desktop
finish-args:
  - --device=dri
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-public-share
  - --filesystem=xdg-videos
  # unix socket access
  - --filesystem=/run/libvirt
  # ssh-agent pid and socket
  #- --filesystem=xdg-run/ssh
  - --own-name=org.virt-manager.virt-manager
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
# - --talk-name=org.freedesktop.Notifications
# - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/bash-completion
  - /share/man
cleanup-commands:
  - /app/cleanup-BaseApp.sh
  - rm -f /app/cleanup-BaseApp.sh
modules:
  - name: virt-manager
    buildsystem: simple
    build-commands:
      - python3 setup.py configure --prefix=/app
      - python3 setup.py build
      - python3 setup.py install --root /
#     - ln -s ../../var/run /app/var/run
#     - python3 setup.py --no-update-icon-cache --no-compile-schemas install --root /
#     - python3 -m compileall /app/share/virt-manager
#     - python3 -O -m compileall /app/share/virt-manager
    sources:
      - type: archive
        url: https://github.com/virt-manager/virt-manager/archive/v3.2.0.tar.gz
        sha256: 74bf899e25ef2751e6b9b7b46a4e79760cd3e8adb5a5fc474944507a4587e0fd
      - type: patch
        path: 0001-virt-manager-disable-man-pages.patch
    modules:
      - ../flathub-shared-modules/intltool/intltool-0.51.json
      - ../shared-modules/python-gobject/python-gobject.json
      - ../shared-modules/gtksourceview4/gtksourceview4.json
      - ../shared-modules/vte3/vte3.json
      - python-dependencies.json
      - name: libosinfo
        buildsystem: meson
        config-opts:
          - -Dwith-usb-ids-path=/app/share/hwdata/usb.ids
          - -Dwith-pci-ids-path=/app/share/hwdata/pci.ids
        sources:
          - type: archive
            url: https://releases.pagure.org/libosinfo/libosinfo-1.9.0.tar.xz
            sha256: b4f3418154ef3f43d9420827294916aea1827021afc06e1644fc56951830a359
        cleanup:
          - /share/gtk-doc
          - /share/vala
        modules:
          - name: osinfo-db
            buildsystem: simple
            build-commands:
              - osinfo-db-import --system osinfo-db.tar.xz
            sources:
              - type: file
                url: https://releases.pagure.org/libosinfo/osinfo-db-20210312.tar.xz
                sha256: 7548ec09e445ca7378c5ceb99e39edca8857f8293831e0b3cb558f4230870e10
                dest-filename: osinfo-db.tar.xz
            modules:
              - name: osinfo-db-tools
                buildsystem: meson
                sources:
                  - type: archive
                    url: https://releases.pagure.org/libosinfo/osinfo-db-tools-1.9.0.tar.xz
                    sha256: 255f1c878bacec70c3020ff5a9cb0f6bd861ca0009f24608df5ef6f62d5243c0
                cleanup:
                  - '*'
