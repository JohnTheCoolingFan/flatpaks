#
# TODO: package flatpak? possible sources of pain: rofiles-fuse, maybe reflinks?
# TODO: find out why rofiles lock is not being cleaned when early exit
#
app-id: io.github.flatpak.flatpak-builder
branch: '20.08'
runtime: org.freedesktop.Sdk
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: flatpak-builder
finish-args:
  - --allow=devel
  - --device=all
  - --share=network
  - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.freedesktop.Flatpak.*
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
modules:
  - name: flatpak-builder
    sources:
      - type: archive
        url: https://github.com/flatpak/flatpak-builder/releases/download/1.0.12/flatpak-builder-1.0.12.tar.xz
        sha256: 4780c1b8e0838ffb64e9639bd7801417964fd818c7c6d5e9afca4d5511ded2c8
      - type: shell
        commands:
          - sed -i 's/\(FLATPAK_VERSION=\).*/\1100.0.0/' configure
    modules:
      - ../shared-modules/libyaml/libyaml.json
      - name: ostree
        config-opts:
          - --libexec=/app/lib
        sources:
          - type: archive
            url: https://github.com/ostreedev/ostree/releases/download/v2021.2/libostree-2021.2.tar.xz
            sha256: 854008e7c71d44f6b3670f0e9b8500db0f08ff8b297d0b30a7cb9a66f34c5d7c
        cleanup:
          - /bin/ostree
          - /etc
          - /lib/girepository-1.0
          - /lib/libostree
          - /lib/ostree
          - /lib/tmpfiles.d
          - /share
        modules:
          - name: fuse2
            config-opts:
              - MOUNT_FUSE_PATH=/app/bin
            sources:
              - type: archive
                url: https://github.com/libfuse/libfuse/releases/download/fuse-2.9.9/fuse-2.9.9.tar.gz
                sha256: d0e69d5d608cc22ff4843791ad097f554dd32540ddc9bed7638cc6fea7c1b4b5
            cleanup:
              - /bin/ulockmgr_server
              - /share/man
          - ../shared-modules/flatpak-spawn-wrappers/fusermount.json
      - name: breezy
        buildsystem: simple
        build-commands:
          - python setup.py build
          - python setup.py install --skip-build --prefix=/app --root=/ --install-data=app/share --optimize=1
          - ln -s brz /app/bin/bzr
        sources:
          - type: archive
            url: https://github.com/breezy-team/breezy/archive/3.1.0-8.tar.gz
            sha256: a2781e9af980ceb62087a78894c2706b17f2ea044253dff7d03fc14f1e4f75d9
        cleanup:
          - /share/man
        modules:
          - breezy-python-dependencies.json
      - name: flatpak
        buildsystem: simple
        build-commands:
          - install -Dm755 flatpak -t /app/bin/
        sources:
          - type: script
            dest-filename: flatpak
            commands:
              - flatpak-spawn --host flatpak "$@"
      - ../shared-modules/rpmextract/rpmextract.json
