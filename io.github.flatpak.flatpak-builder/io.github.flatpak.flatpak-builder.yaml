app-id: io.github.flatpak.flatpak-builder
runtime: org.freedesktop.Sdk
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: flatpak-builder
finish-args:
  - --allow=devel
  - --device=all
  - --share=network
  - --talk-name=org.freedesktop.Flatpak
  # TODO: probably can be replaced with org.freedesktop.Flatpak.Development
  - --talk-name=org.freedesktop.Flatpak.*
  # workaround for flatpak-spawn failing to talk with the host on early exit and unmount rofile-fuse
  # TODO: find a better solution to make flatpak-spawn work on early exit
  - --socket=session-bus
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
  - '*.la'
modules:
  - name: flatpak-builder
    sources:
      - type: archive
        url: https://github.com/flatpak/flatpak-builder/releases/download/1.1.2/flatpak-builder-1.1.2.tar.xz
        sha256: f5d8e954daba2a406341cfcfb32a28ddaa503b2cd936dc7b1871187221f7510d
        x-checker-data:
          type: anitya
          project-id: 16046
          stable-only: true
          url-template: https://github.com/flatpak/flatpak-builder/releases/download/$version/flatpak-builder-$version.tar.xz
      - type: shell
        commands:
          - sed -i 's/\(FLATPAK_VERSION=\).*/\1100.0.0/' configure
    modules:
      - ../shared-modules/libyaml/libyaml.json
      - name: ostree
        config-opts:
          - --libexec=/app/lib
        sources:
          - type: archive
            url: https://github.com/ostreedev/ostree/releases/download/v2021.4/libostree-2021.4.tar.xz
            sha256: db5ce01a1606af3466ec77236700f53a63ce20e4984a549d0eaba3f66a3d9361
            x-checker-data:
              type: anitya
              project-id: 10899
              stable-only: true
              url-template: https://github.com/ostreedev/ostree/releases/download/v$version/libostree-$version.tar.xz
        cleanup:
          - /bin/ostree
          - /etc
          - /lib/girepository-1.0
          - /lib/libostree
          - /lib/ostree
          - /lib/tmpfiles.d
          - /share
        modules:
          - ../shared-modules/fuse/fuse2.json
          - ../shared-modules/breezy/breezy.json
      - ../shared-modules/flatpak-spawn-wrappers/flatpak.json
      - ../shared-modules/rpmextract/rpmextract.json
