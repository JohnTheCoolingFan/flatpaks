app-id: com.fcitx_im.fcitx.ime.rime
runtime: com.fcitx_im.fcitx
sdk: org.gnome.Sdk//3.36
build-extension: true
separate-locales: false
build-options:
  prefix: /app/ime/rime
  libdir: /app/ime/rime/lib
  ldflags: -L/app/ime/rime/lib
  prepend-pkg-config-path: /app/ime/rime/lib/pkgconfig
  prepend-ld-library-path: /app/ime/rime/lib
  prepend-path: /app/ime/rime/bin
  cflags: -I/app/ime/rime/include
  cxxflags: -I/app/ime/rime/include
modules:
  - name: fcitx-rime
    buildsystem: cmake
    build-options:
      cxxflags: '-DNDEBUG'
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_QT=Off
    sources:
      - type: archive
        url: https://download.fcitx-im.org/fcitx-rime/fcitx-rime-0.3.2.tar.xz
        sha256: f97ea6f515fcc5f526cc25dce3d4ba05fa1c83001f68502d6c284ba39cd5a82d
      - type: shell
        commands:
          - sed -i 's/FCITX4_PREFIX/CMAKE_INSTALL_PREFIX/g' data/CMakeLists.txt
    modules:
      - name: librime
        buildsystem: cmake
        builddir: true
        config-opts:
          - -DBUILD_MERGED_PLUGINS=Off
          - -DBUILD_TEST=Off
        sources:
          - type: archive
            url: https://github.com/rime/librime/archive/1.5.3.tar.gz
            sha256: df4279df6bc0419c18d9325e7d76dfdab8f91f0ee00a954f19a27f66dd99f503
          - type: archive
            url: https://github.com/lotem/librime-octagram/archive/3664bc9d0426397541e6dcfb7c3c7d6aaad73b2e/librime-octagram-3664bc9d0426397541e6dcfb7c3c7d6aaad73b2e.tar.gz
            sha256: 1b5f49a4953d1da66fa858c5b67ed158453553d676ddac474a96ffa8885e11e5
            dest: plugins/librime-octagram
          - type: archive
            url: https://github.com/hchunhui/librime-lua/archive/d284336635330c2cba499d4ece7445cfd4928370/librime-lua-d284336635330c2cba499d4ece7445cfd4928370.tar.gz
            sha256: 333534e98792cd71a349859230860d76da0c5541749339857cff30ace791077e
            dest: plugins/librime-lua
          - type: file
            url: https://github.com/rime/librime/commit/beae5b1d4e990aeb05eb86db5eefec50fa03750b.patch
            sha256: be08634d1c782c035af1b617549f98d6d97dc1bc39f9f1224fecf305e5e6fc47
            dest-filename: librime-opencc-1.1.patch
          - type: shell
            commands:
              - patch -p1 -i librime-opencc-1.1.patch
        modules:
          - ../flathub-shared-modules/lua5.1/lua-5.1.5.json
         #- name: boost-libs
          - ../shared-modules/boost/boost.json
          - name: google-glog
            sources:
              - type: archive
                url: https://github.com/google/glog/archive/v0.4.0.tar.gz
                sha256: f28359aeba12f30d73d9e4711ef356dc842886968112162bc73002645139c39c
          - name: yaml-cpp
            buildsystem: cmake
            config-opts:
              - -DCMAKE_BUILD_TYPE=Release
              - -DBUILD_SHARED_LIBS=ON
              - -DYAML_BUILD_SHARED_LIBS=ON
            sources:
              - type: archive
                url: https://github.com/jbeder/yaml-cpp/archive/yaml-cpp-0.6.3.tar.gz
                sha256: 77ea1b90b3718aa0c324207cb29418f5bced2354c2e483a9523d98c3460af1ed
          - name: leveldb
            buildsystem: cmake
            config-opts:
              - -DCMAKE_INSTALL_LIBDIR=lib
              - -DCMAKE_BUILD_TYPE=Release
              - -DBUILD_SHARED_LIBS=1
            sources:
              - type: archive
                url: https://github.com/google/leveldb/archive/1.22.tar.gz
                sha256: 55423cac9e3306f4a9502c738a001e4a339d1a38ffbee7572d4a07d5d63949b2
#           modules:
#             - name: snappy
#             - name: gperftools
          - name: marisa
            build-commands:
              - make -C bindings swig-python
              - cd bindings/python && python3 setup.py build_ext
                --include-dirs=../../include
                --library-dirs=../../lib/marisa/.libs
              - cd bindings/python && python3 setup.py build
            post-install:
              - cd bindings/python && python3 setup.py install --prefix=${FLATPAK_DEST}
            sources:
              - type: archive
                url: https://github.com/s-yata/marisa-trie/archive/v0.2.6.tar.gz
                sha256: 1063a27c789e75afa2ee6f1716cc6a5486631dcfcb7f4d56d6485d2462e566de
              - type: shell
                commands:
                  - autoreconf -i
            modules:
              - name: swig
                sources:
                  - type: archive
                    url: https://downloads.sourceforge.net/swig/swig-4.0.2.tar.gz
                    sha256: d53be9730d8d58a16bf0cbd1f8ac0c0c3e1090573168bfa151b01eb47fa906fc
          - name: opencc
            buildsystem: cmake
            sources:
              - type: archive
                url: https://github.com/BYVoid/OpenCC/archive/ver.1.1.1/opencc-1.1.1.tar.gz
                sha256: 2d4987dc84275f252d47bc6d8c81b452f6a6e82caa26f284c854a8153ccf5933
#           modules:
#             - name: python-setuptools
#             - name: python-wheel
      - name: librime-data
        modules:
          - name: rime-essay
            buildsystem: simple
            build-commands:
              - install -Dm644 *.txt -t ${FLATPAK_DEST}/share/rime-data/
            sources:
              - type: archive
                url: https://github.com/rime/rime-essay/archive/917e5691d090f75c40f0bc72476c2f483bae0c21/rime-essay-917e5691d090f75c40f0bc72476c2f483bae0c21.tar.gz
                sha256: 832397c54b70598dcbea25158163dd79093e84891f6db6611f17634f7e40977f
          - name: rime-prelude
            buildsystem: simple
            build-commands:
              - install -Dm644 *.yaml -t ${FLATPAK_DEST}/share/rime-data/
            sources:
              - type: archive
                url: https://github.com/rime/rime-prelude/archive/8a52b4f86a59f3eb602f9a4cf6a680a67c15df8c/rime-prelude-8a52b4f86a59f3eb602f9a4cf6a680a67c15df8c.tar.gz
                sha256: 0b14a46b0bde9997bf20cac89df5222580bf5544942ab6726b15029664d952b4
#         - name: rime-bopomofo
#           modules:
#             - name: rime-cangjie
#               modules:
#                 - name: rime-luna-pinyin
#                   modules:
#                     - name: rime-stroke
#                       modules:
#                         - name: rime-luna-pinyin
#             - name: rime-terra-pinyin
#               modules:
#                 - name: rime-stroke
