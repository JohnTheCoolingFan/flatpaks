# Bugs
#   https://gitlab.com/fcitx/fcitx/-/issues/429
#   https://github.com/flatpak/flatpak/issues/2031
#
# Todo
#   does it need notifications?
#   check what extra settings windows available with qt5
#   more skins
#   add missing modules

app-id: com.fcitx_im.fcitx
# needed for notifications that are not working with the freedesktop runtime
runtime: org.gnome.Platform
runtime-version: '3.36'
sdk: org.gnome.Sdk
add-extensions:
  com.fcitx_im.fcitx.ime:
    directory: ime
    merge-dirs: bin;lib/fcitx;share/fcitx/addon;share/fcitx/configdesc;share/fcitx/imicon;share/fcitx/inputmethod;share/fcitx/skin/classic;share/fcitx/skin/dark;share/fcitx/skin/default;share/fcitx/table
    subdirectories: true
    no-autodownload: true
    add-ld-path: lib
  com.fcitx_im.fcitx.ime.base:
    directory: ime/base
    no-autodownload: false
    bundle: true
command: fcitx
finish-args:
  - --device=dri
  - --env=PATH=/app/ime/bin:/app/bin:/usr/bin
  - --own-name=org.fcitx.*
  - --own-name=org.freedesktop.portal.Fcitx
  - --own-name=org.kde.*
  - --share=ipc
  - --share=network
  - --socket=wayland
  - --socket=x11
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
cleanup:
# - /include
# - /lib/pkgconfig
  - /share/man
  - '*.a'
  - '*.la'
modules:
  - name: fcitx
#   cleanup:
#     - /share/cmake
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DSYSCONFDIR=/app/etc
      - -DFORCE_OPENCC=ON
      - -DFORCE_PRESAGE=ON
      - -DFORCE_ENCHANT=ON
      - -DENABLE_TEST=OFF
      - -DENABLE_QT=OFF
      - -DENABLE_GTK2_IM_MODULE=OFF
      - -DENABLE_GTK3_IM_MODULE=ON
      - -DENCHANT_INCLUDE_DIR=/app/include/enchant-2/
      - -DENCHANT_LIBRARIES=/app/lib/libenchant-2.so
      - -DENABLE_GIR=OFF
      #- -DGOBJECT_INTROSPECTION_GIRDIR=/app/share/gir-1.0
    post-install:
      - mkdir -p /app/ime
      - ./rename_icons
        # create base extension
      - |
          mkdir -p /app/ime/base/{lib,share/fcitx}
          mv /app/lib/fcitx /app/ime/base/lib/
          mv /app/share/fcitx/{addon,configdesc,imicon,inputmethod,skin,table} /app/ime/base/share/fcitx/

          for _res in lib/fcitx share/fcitx/{addon,configdesc,imicon,inputmethod,skin,table}; do
            ln -s /app/ime/${_res} /app/${_res}
          done
        # fix cmake include source for to build fcitx extensions
      - |
          sed -i '$a\
          \
          SET(FCITX4_ADDON_CONFIG_INSTALL_DIR ${CMAKE_INSTALL_PREFIX}/share/fcitx/addon)\
          SET(FCITX4_INPUTMETHOD_CONFIG_INSTALL_DIR ${CMAKE_INSTALL_PREFIX}/share/fcitx/inputmethod)\
          SET(FCITX4_ADDON_INSTALL_DIR ${CMAKE_INSTALL_PREFIX}/lib/fcitx)\
          SET(FCITX4_CONFIGDESC_INSTALL_DIR ${CMAKE_INSTALL_PREFIX}/share/fcitx/configdesc)' \
          /app/share/cmake/fcitx/FcitxConfig.cmake
          # TODO: handle extensions share/locale?
        # googlepinyin
      - ln -s -t /app/lib/ /app/ime/googlepinyin/lib/googlepinyin
        # libpinyin
      - ln -s -t /app/lib/ /app/ime/libpinyin/lib/libpinyin
      - ln -s -t /app/share/fcitx/ /app/ime/libpinyin/share/fcitx/libpinyin
        # anthy
      - ln -s -t /app/share/ /app/ime/anthy/share/anthy
        # chewing
      - ln -s -t /app/share/ /app/ime/chewing/share/libchewing
        # hangul
      - ln -s -t /app/share/ /app/ime/hangul/share/libhangul
      - ln -s -t /app/share/fcitx/ /app/ime/hangul/share/fcitx/hangul
        # sunpiyin
          # TODO: lib/scons symlink?
      - ln -s -t /app/share/ /app/ime/sunpinyin/share/sunpinyin
        # skk
          # TODO: lib/girepository-1.0 symlink?
          # TODO: share/gir-1.0 symlink?
      - ln -s -t /app/share/fcitx /app/ime/skk/share/fcitx/skk
      - ln -s -t /app/share/ /app/ime/skk/share/libskk
        # m17n
      - ln -s -t /app/lib/ /app/ime/m17n/lib/m17n
      - ln -s -t /app/share/fcitx/ /app/ime/m17n/share/fcitx/m17n
      - ln -s -t /app/share/ /app/ime/m17n/share/m17n
        # kkc
          # TODO: lib/girepository-1.0 symlink?
          # TODO: lib/python3.7 symlink? or PYTHONPATH?
          # TODO: share/gir-1.0 symlink?
      - ln -s -t /app/lib/ /app/ime/kkc/lib/libkkc
      - ln -s -t /app/share/fcitx/ /app/ime/kkc/share/fcitx/kkc
      - ln -s -t /app/share/ /app/ime/kkc/share/libkkc
      - ln -s -t /app/share/ /app/ime/kkc/share/skk
        # mozc
      - ln -s -t /app/lib/ /app/ime/mozc/lib/mozc
        # rime
      - ln -s -t /app/lib/ /app/ime/rime/lib/rime-data
    sources:
      - type: archive
        url: https://download.fcitx-im.org/fcitx/fcitx-4.2.9.7_dict.tar.xz
        sha256: cf333b2a90be616ffed8b83438dfe3dc0e22ecf034b9f651167203ecbe3f6f8f
      - type: patch
        path: fcitx-exportable-icon_names.patch
      - type: file
        path: rename_icons
    modules:
      - name: extra-cmake-modules
        cleanup:
          - '*'
        buildsystem: cmake
        config-opts:
          - -DBUILD_HTML_DOCS=OFF
          - -DBUILD_QTHELP_DOCS=OFF
          - -DBUILD_TESTING=OFF
        sources:
          - type: archive
            url: https://download.kde.org/stable/frameworks/5.69/extra-cmake-modules-5.69.0.tar.xz
            sha256: dacc8e0be8605b6c609ea35bda2d87bf06e1d228bcbf8957b0f0230c4a888359
      - name: json-c
        cleanup:
          - /lib/cmake
        buildsystem: cmake
        config-opts:
          - -DCMAKE_BUILD_TYPE=None
          - -DENABLE_THREADING=ON
          - -DENABLE_RDRAND=OFF
        sources:
          - type: archive
            url: https://github.com/json-c/json-c/archive/json-c-0.14-20200419.tar.gz
            sha256: ec4eb70e0f6c0d707b9b1ec646cf7c860f4abb3562a90ea6e4d78d177fd95303
      - name: enchant
        config-opts:
          - --disable-static
          - --disable-ispell
          - --with-myspell-dir=/app/share/myspell
        sources:
          - type: archive
            url: https://github.com/AbiWord/enchant/releases/download/v2.2.8/enchant-2.2.8.tar.gz
            sha256: c7b5e2853f0dd0b1aafea2f9e071941affeec3a76df8e3f6d67a718c89293555
      - name: opencc
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/BYVoid/OpenCC/archive/ver.1.1.1/opencc-1.1.1.tar.gz
            sha256: 2d4987dc84275f252d47bc6d8c81b452f6a6e82caa26f284c854a8153ccf5933
       #modules:
       #  - name: python-setuptools
       #  - name: python-wheel
  - name: fcitx-configtool
    buildsystem: cmake
    sources:
      - type: archive
        url: https://download.fcitx-im.org/fcitx-configtool/fcitx-configtool-0.4.10.tar.xz
        sha512: 1c1267e9de694bbd5f258b5bba1e7514c4f8556cdc82a1cce5eafd8a4ec571955285dade0acd02f128eca01f867a30c5c6264ee7e91d32a333eba6e4d275fe8f
  - name: install-icons
    buildsystem: simple
    build-commands:
      - ./install_icons
    sources:
      - type: file
        path: install_icons
      - type: dir
        path: resources
# - name: fcitx-skin-material
#   buildsystem: simple
#   build-commands:
#     - install -d /app/share/fcitx/skin/material
#     - install -m644 material/* /app/share/fcitx/skin/material/
#   sources:
#     - type: archive
#       url: https://github.com/hrko99/fcitx-skin-material/archive/v0.5.tar.gz
#       sha256: f2819f2053d8f1cceeb6b7fb917d11494ea962a9370fe095a580d7c41b1e40bb
