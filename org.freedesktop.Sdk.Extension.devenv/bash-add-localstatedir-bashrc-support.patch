From 22c24b4ea95747f5b1824787dc35a741aa613b95 Mon Sep 17 00:00:00 2001
From: tinywrkb <tinywrkb@gmail.com>
Date: Mon, 18 Jul 2022 15:49:48 +0300
Subject: [PATCH] add localstatedir bashrc support

---
 config-top.h |  3 +++
 shell.c      | 17 +++++++++++++++--
 2 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/config-top.h b/config-top.h
index c97168f..540150c 100644
--- a/config-top.h
+++ b/config-top.h
@@ -95,6 +95,9 @@
 /* System-wide .bashrc file for interactive shells. */
 #define SYS_BASHRC "/usr/lib/sdk/devenv/etc/bash.bashrc"
 
+/* Local-state .bashrc file for interactive shells. */
+#define STATE_BASHRC "/var/lib/devenv/etc/bash.bashrc"
+
 /* System-wide .bash_logout for login shells. */
 #define SYS_BASH_LOGOUT "/usr/lib/sdk/devenv/etc/bash.bash_logout"
 
diff --git a/shell.c b/shell.c
index ce8087f..77d30ac 100644
--- a/shell.c
+++ b/shell.c
@@ -1102,6 +1102,7 @@ run_startup_files ()
   int old_job_control;
 #endif
   int sourced_login, run_by_ssh;
+  int r;
 
   /* get the rshd/sshd case out of the way first. */
   if (interactive_shell == 0 && no_rc == 0 && login_shell == 0 &&
@@ -1120,9 +1121,21 @@ run_startup_files ()
 	{
 #ifdef SYS_BASHRC
 #  if defined (__OPENNT)
-	  maybe_execute_file (_prefixInstallPath(SYS_BASHRC, NULL, 0), 1);
+	  r = maybe_execute_file (_prefixInstallPath(SYS_BASHRC, NULL, 0), 1);
+#     if defined (STATE_BASHRC)
+    if (r < 0)
+      {
+        maybe_execute_file (_prefixInstallPath(STATE_BASHRC, NULL, 0), 1);
+      }
+#     endif
 #  else
-	  maybe_execute_file (SYS_BASHRC, 1);
+	  r = maybe_execute_file (SYS_BASHRC, 1);
+#     if defined (STATE_BASHRC)
+    if (r < 0)
+      {
+        maybe_execute_file (STATE_BASHRC, 1);
+      }
+#     endif
 #  endif
 #endif
 	  maybe_execute_file (bashrc_file, 1);
-- 
2.36.1

