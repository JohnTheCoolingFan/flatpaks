app-id: org.rclone.rclone
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
command: rclone
finish-args:
  - --share=network
  - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.freedesktop.Flatpak.*
build-options:
  no-debuginfo: true
modules:
  - name: rclone
    buildsystem: simple
    build-options:
      env:
        - GOBIN=/app/bin
        - GOROOT=/usr/lib/sdk/golang
        - GOFLAGS=-modcacherw
      append-path: /usr/lib/sdk/golang/bin
      build-args:
        - --share=network
    build-commands:
      - |
         export GOPATH=$PWD
         go get github.com/rclone/rclone@latest
         #chmod u+w -R pkg
         go install github.com/rclone/rclone@latest
  - name: fusermount
    buildsystem: simple
    build-commands:
      - install -Dm755 fusermount -t /app/bin/
    sources:
      - type: script
        dest-filename: fusermount
        commands:
          - |

             # source: https://github.com/flathub/org.flatpak.Builder/blob/master/fusermount-wrapper.sh

             if [ -z "$_FUSE_COMMFD" ]; then
                 FD_ARGS=
             else
                 FD_ARGS="--env=_FUSE_COMMFD=${_FUSE_COMMFD}"
                 [ "$_FUSE_COMMFD" -gt 3 ] && FD_ARGS+=" --forward-fd=${_FUSE_COMMFD}"
             fi

             exec flatpak-spawn --host --forward-fd=1 --forward-fd=2 --forward-fd=3 $FD_ARGS fusermount "$@"
