# WARNING: WIP and experimental
# WARNING: this will only work with a patched flatpak build which allows /proc access during apply_extra
#          see: https://github.com/tinywrkb/pkgbuilds/blob/main/flatpak-slack/0001-Allow-proc-access-during-apply_extra.patch
# TODO: add mimetypes
app-id: org.notepad_plus_plus.notepadpp
runtime: org.winehq.Platform
runtime-version: master
sdk: org.winehq.Sdk
command: npp
finish-args:
  - --filesystem=home
  - --share=network
# - --socket=fallback-x11
  # TODO: evalute dbus access
  - --socket=session-bus
  - --socket=system-bus
modules:
  - name: notepadpp
    buildsystem: simple
    build-commands:
      - install -Dm755 apply_extra npp -t ${FLATPAK_DEST}/bin/
      - install -Dm644 ${FLATPAK_ID}.desktop -t ${FLATPAK_DEST}/share/applications/
      # source: https://notepad-plus-plus.org/images/logo.svg
      - install -Dm644 ${FLATPAK_ID}.svg -t ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/
    sources:
      - type: extra-data
        filename: npp-installer.exe
        url: https://github.com/notepad-plus-plus/notepad-plus-plus/releases/download/v8.1.9/npp.8.1.9.Installer.x64.exe
        sha256: 23bde004114ee4d17b11608da2c78fda365874fd64194a6ea167dd3050576b42
        size: 4345424
      - type: script
        dest-filename: apply_extra
        commands:
          # TODO: install in a headless xorg session
          - |
            export WINEPREFIX=$PWD
            export Hostname=hostname
            export TZ=UTC
            export USER=User
            wine npp-installer.exe /S
          - rm npp-installer.exe
          # TODO: clean system-specific unique ids
          #        - Software\\Microsoft\\Cryptography: MachineGuid
          - |
            rm dosdevices/{c,z}\:
            rmdir dosdevices

            pushd drive_c

            mv users{,.ro}
            ln -s /var/data/wine/users users

            pushd users.ro/Public
            rmdir Desktop Documents Music Pictures Videos
            popd

            pushd users/User
            rmdir Contacts Favorites Links "Saved Games" Searches Temp
            rm Desktop Documents Downloads Music Pictures Videos
            popd

            pushd windows
            rm -rf Installer logs temp
            ln -s /var/cache/wine/temp temp
            ln -s -t ./ /var/cache/wine/windows/{Installer,logs,temp}
            popd
      - type: file
        path: npp
      - type: file
        path: org.notepad_plus_plus.notepadpp.desktop
      - type: file
        path: org.notepad_plus_plus.notepadpp.svg
